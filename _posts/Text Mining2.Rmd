---
title: "Text Mining2"
author: "Lisa"
date: "December 9, 2015"
output: 
  html_document:
    toc: true
    toc_depth: 3
    theme: united
    highlight: tango
---


```{r,warning=FALSE,message=FALSE}
library(tidyr)
library(dplyr)
library(tm)
library(stringr)
library(DT)
rm(list=ls())
radiology=read.csv("radiology_results.csv",header = TRUE, stringsAsFactors=FALSE) #set strings As Strings
rad=radiology #make a copy of data
#split the TEST_ORDERED into single test
rad1= rad %>% separate(TEST_ORDERED, c("T1", "T2","T3"), sep=",", extra = "drop", fill = "right")
#datatable(head(rad1[,-7],10))
#rad2=filter(rad1, T1 == "XR Abdomen"|T2 == "XR Abdomen"|T3 == "XR Abdomen")
rad2=filter(rad1, T1 == "XR Abdomen")
rad2=rad2[,c(1:3,6:7)]
```

#Extract key word from text

Next, Let's try to decide whether those patients with "XR Abdominal" test have "free air", "no free air" or "no evidence of both".

For starters, lets extract all the text related with "free air". 

* Abdominal result: `ABDOMEN`
* Related free air: `[A-Za-z]*air|free air|No free air|no free air`
* Negative view: `No evidence|no evidence`

There are some regular expressions. Let's make regex for each thing we want to extract:

```{r}
pattern=c("ABDOMEN","[A-Za-z]*air|free air|No free air|no free air","No evidence|no evidence")
pattern=paste(pattern, sep = "|", collapse="|")

#orignial text
text=rad2$RESULT
#Let's extract all the words from the text using str_extract_all (like grep(...,value = TRUE))
words <- str_extract_all(text, "[A-Za-z]{2,}")
#Let's only extract the words related to "free air"
freeair <- str_extract_all(text, pattern)
head(freeair,10)


#Extract no free air patients
pattern=c("[Nn]*o free [A-Za-z]*air|[Nn]*o free air",
          "[Nn]*o evidence of free [A-Za-z]*air",
          "[Nn]*o evidence of [a-z]* [A-Za-z]*air|[Nn]*o evidence of any free air")
pattern=paste(pattern, sep = "|", collapse="|")
nofreeair <- str_extract_all(text, pattern)
head(nofreeair,15)
#There are 5875 patients have no free air
length(nofreeair[lapply(nofreeair,length)>0])

```

To be continue,...



#Extract words with capital letters

I found each text is separated by some paragraphs which can be summarised to several topics in capital letters, such as "CLINICAL INDICATION", "ABDOMEN", "CERVICAL SPINE CLINICAL" and etc. So let's have a try for fun.


```{r,message=FALSE}
library("wordcloud")
library("wesanderson")
topic <- str_extract_all(text, "[A-Z]{2,} [A-Z]{2,} [A-Z]{2,}|[A-Z]{2,} [A-Z]{2,}|[A-Z]{2,}")
head(topic)

word_counts <- unlist(topic) %>% table %>% data.frame
names(word_counts) <- c("word", "count")
word_counts %>%
    top_n(25)%>%
    arrange(count)


pal <- wes_palette(name = "Zissou", 25, type ="continuous") %>% as.character()

word_counts %>%
    top_n(25) %>%
    with(wordcloud(word, count, ordered.colors = TRUE, colors = pal, use.r.layout = TRUE,scale = c(2.5, 0.5)))


```

